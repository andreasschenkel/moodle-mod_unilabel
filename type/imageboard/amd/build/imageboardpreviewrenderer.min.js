define("unilabeltype_imageboard/imageboardpreviewrenderer",["exports","core/templates","core/str","core/log"],(function(_exports,_templates,Str,_log){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Unilabel type imageboard
   *
   * @author      Andreas Schenkel
   * @copyright   Andreas Schenkel {@link https://github.com/andreasschenkel}
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_templates=_interopRequireDefault(_templates),Str=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Str),_log=_interopRequireDefault(_log);_exports.init=(canvaswidth,canvasheight,gridcolor,xsteps,ysteps)=>{canvaswidth=parseInt(canvaswidth,10),canvasheight=parseInt(canvasheight,10),xsteps=parseInt(xsteps,10),ysteps=parseInt(ysteps,10),function(){var mform=document.querySelectorAll('[id^="mform"]')[0];mform.addEventListener("focusout",focusoutExecute,!1),mform.addEventListener("click",onclickExecute,!1),mform.addEventListener("contextmenu",onRightclick,!1);let backgroundfileNode=document.getElementById("id_unilabeltype_imageboard_backgroundimage_fieldset");if(backgroundfileNode){new MutationObserver(refreshBackgroundImage).observe(backgroundfileNode,{attributes:!0,childList:!0,subtree:!0})}let canvasx=document.getElementById("id_unilabeltype_imageboard_canvaswidth");if(canvasx){new MutationObserver(refreshBackgroundImage).observe(canvasx,{attributes:!0,childList:!0,subtree:!0})}let canvasy=document.getElementById("id_unilabeltype_imageboard_canvasheight");if(canvasy){new MutationObserver(refreshBackgroundImage).observe(canvasy,{attributes:!0,childList:!0,subtree:!0})}}(),setTimeout(refreshBackgroundImage,1e3),setTimeout(refreshAllImages,1e3),setTimeout((function(){!function(canvaswidth,canvasheight,gridcolor,xsteps,ysteps){let helpergrids=[];for(let y=0;y<canvasheight;y+=ysteps)for(let x=0;x<canvaswidth;x+=xsteps){let helpergrid={};helpergrid.x=x,helpergrid.y=y,helpergrids.push(helpergrid)}const context={helpergrids:helpergrids,gridcolor:gridcolor,xsteps:xsteps,ysteps:ysteps,cmid:0,hidden:0};_templates.default.renderForPromise("unilabeltype_imageboard/imageboard_helpergridpreview",context).then((_ref=>{let{html:html,js:js}=_ref,combined="<div>"+document.getElementById("imageboardcontainer").innerHTML+"</div>"+html;_templates.default.replaceNodeContents("#imageboardcontainer",combined,js)})).catch((()=>{_log.default.debug("Rendering failed")}))}(canvaswidth,canvasheight,gridcolor,xsteps,ysteps)}),1e3);const gridtoggler=document.getElementById("unilabeltype-imageboard-gridtoggler-0"),togglerText=gridtoggler.querySelector(".unilabeltype-imageboard-toggle-text");function focusoutExecute(event){let imagenumber=-1;const eventid=event.target.getAttribute("id");let eventsourceimagesetting=eventid.split("id-unilabeltype-imageboard-imagesettings-")[1],eventsourceform=eventid.split("id_unilabeltype_imageboard_")[1];if(void 0!==eventsourceimagesetting||void 0!==eventsourceform){if(void 0!==eventsourceimagesetting&&""!==eventsourceimagesetting&&(imagenumber=function(eventsourceimagesetting){const imagenumber=parseInt(document.getElementById("id-unilabeltype-imageboard-imagesettings-number").innerHTML)-1;let value=document.getElementById("id-unilabeltype-imageboard-imagesettings-"+eventsourceimagesetting).value;if("xposition"===eventsourceimagesetting||"yposition"===eventsourceimagesetting||"border"===eventsourceimagesetting||"borderradius"===eventsourceimagesetting){let num=Number(value);if(""!==value&&!Number.isInteger(num))return-1}let field=document.getElementById("id_unilabeltype_imageboard_"+eventsourceimagesetting+"_"+imagenumber);null!==field&&(field.value=value);return imagenumber}(eventsourceimagesetting)),void 0!==eventsourceform&&""!==eventsourceform){writeFormdataOfImageToImagesettingsdialogupdate(eventsourceform.substr(eventsourceform.length-1,eventsourceform.length))}imagenumber>=0?refreshImage(imagenumber):refreshAllImages()}}function writeFormdataOfImageToImagesettingsdialogupdate(technicalnumber){let selectedImage=getAllImagedataFromForm(technicalnumber);document.getElementById("id-unilabeltype-imageboard-imagesettings-number").innerHTML=parseInt(selectedImage.technicalnumber)+1;document.getElementById("id-unilabeltype-imageboard-imagesettings-title").value=selectedImage.title;document.getElementById("id-unilabeltype-imageboard-imagesettings-xposition").value=parseInt(selectedImage.xposition);document.getElementById("id-unilabeltype-imageboard-imagesettings-yposition").value=parseInt(selectedImage.yposition);document.getElementById("id-unilabeltype-imageboard-imagesettings-border").value=parseInt(selectedImage.border);document.getElementById("id-unilabeltype-imageboard-imagesettings-borderradius").value=parseInt(selectedImage.borderradius)}function onclickExecute(event){event.target.getAttribute("id").split("button-mform1")[1]?setTimeout((function(){addImageToDom(document.querySelectorAll('[id^="fitem_id_unilabeltype_imageboard_title_"]').length-1)}),500):"id-unilabeltype-imageboard-imagesettings-close"===event.target.getAttribute("id")&&imagesettingsdivvisibility("hidden")}function onRightclick(event){event.preventDefault();var idoftarget=event.target.getAttribute("id");if(!idoftarget)return;let technicalnumber=idoftarget.split("unilabel-imageboard-imageid-")[1];if(technicalnumber||(technicalnumber=idoftarget.split("id_elementtitle-")[1]),technicalnumber){writeFormdataOfImageToImagesettingsdialogupdate(technicalnumber);technicalnumber==parseInt(document.getElementById("id-unilabeltype-imageboard-imagesettings-number").innerHTML)?function(){let imagesettingsdiv=document.getElementById("id-unilabeltype-imageboard-imagesettings");imagesettingsdiv&&imagesettingsdiv.style&&"visible"==imagesettingsdiv.style.visibility?imagesettingsdiv.style.visibility="hidden":imagesettingsdiv&&imagesettingsdiv.style&&"hidden"==imagesettingsdiv.style.visibility&&(imagesettingsdiv.style.visibility="visible")}():imagesettingsdivvisibility("visible")}}function imagesettingsdivvisibility(visibility){document.getElementById("id-unilabeltype-imageboard-imagesettings").style.visibility=visibility}function refreshBackgroundImage(){let previewimage=document.getElementById("id_unilabeltype_imageboard_backgroundimage_fieldset").getElementsByClassName("realpreview"),backgrounddiv=document.getElementById("unilabel-imageboard-background-canvas");if(previewimage.length>0){let backgroundurl=previewimage[0].getAttribute("src").split("?")[0];previewimage[0].getAttribute("src").split("?")[1].includes("&oid=")&&(backgroundurl+="?oid="+previewimage[0].getAttribute("src").split("&oid=")[1]),backgrounddiv.style.background="red",backgrounddiv.style.backgroundSize="cover",backgrounddiv.style.backgroundImage="url('"+backgroundurl+"')";let canvaswidth=document.getElementById("id_unilabeltype_imageboard_canvaswidth").selectedOptions[0].value;backgrounddiv.style.width=canvaswidth+"px";let canvasheight=document.getElementById("id_unilabeltype_imageboard_canvasheight").selectedOptions[0].value;backgrounddiv.style.height=canvasheight+"px"}else{backgrounddiv.style.background="green",backgrounddiv.style.backgroundImage="url('')";let canvaswidth=document.getElementById("id_unilabeltype_imageboard_canvaswidth").selectedOptions[0].value;backgrounddiv.style.width=canvaswidth+"px";let canvasheight=document.getElementById("id_unilabeltype_imageboard_canvasheight").selectedOptions[0].value;backgrounddiv.style.height=canvasheight+"px"}}function refreshAllImages(){const singleElements=document.querySelectorAll('[id^="fitem_id_unilabeltype_imageboard_image_"]');for(let i=0;i<singleElements.length;i++){let number=singleElements[i].getAttribute("id").split("fitem_id_unilabeltype_imageboard_image_")[1];null===document.getElementById("unilabel-imageboard-imageid-"+number)?(addImageToDom(number),setTimeout((function(){refreshImage(number)}),1e3)):refreshImage(number)}}function addImageToDom(number){if(null===document.getElementById("unilabel-imageboard-imageid-"+number)){!function(number){const context={number:number,title:"title"};_templates.default.renderForPromise("unilabeltype_imageboard/previewimage",context).then((_ref2=>{let{html:html,js:js}=_ref2,combined="<div>"+document.getElementById("imageboardcontainer").innerHTML+"</div>"+html;_templates.default.replaceNodeContents("#imageboardcontainer",combined,js)})).catch((()=>{}))}(number);let imagefileNode=document.getElementById("fitem_id_unilabeltype_imageboard_image_"+number);if(imagefileNode){new MutationObserver(refreshImage).observe(imagefileNode,{attributes:!0,childList:!0,subtree:!0})}}else refreshImage(number)}function refreshImage(number){if(Array.isArray(number))setTimeout((function(){refreshAllImages()}),600);else{let imageid=document.getElementById("unilabel-imageboard-imageid-"+number),imagedata=getAllImagedataFromForm(number);imageid.style.background=imagedata.titlebackgroundcolor,imageid.src=imagedata.src,""===imagedata.src?imageid.classList.add("hidden"):(imageid.classList.remove("hidden"),imageid.alt=imagedata.alt);const imagediv=document.getElementById("unilabel-imageboard-element-"+number);imagediv.style.left=parseInt(imagedata.xposition)+"px",imagediv.style.top=parseInt(imagedata.yposition)+"px";const idelementtitle=document.getElementById("id_elementtitle-"+number);idelementtitle.classList.remove("unilable-imageboard-titlelineheight-0"),idelementtitle.classList.remove("unilable-imageboard-titlelineheight-1"),idelementtitle.classList.remove("unilable-imageboard-titlelineheight-2"),idelementtitle.classList.remove("unilable-imageboard-titlelineheight-3"),idelementtitle.classList.remove("unilable-imageboard-titlelineheight-4"),idelementtitle.classList.remove("unilable-imageboard-titlelineheight-5");const dummy="unilable-imageboard-titlelineheight-"+imagedata.titlelineheight;idelementtitle.classList.add(dummy),0!=imagedata.targetwidth?imageid.style.width=imagedata.targetwidth+"px":imageid.style.width="auto",0!=imagedata.targetheight?imageid.style.height=imagedata.targetheight+"px":imageid.style.height="auto",""!=imagedata.title?imageid.title=parseInt(number)+1+": "+imagedata.title:imageid.title=parseInt(number)+1+": ",0!=imagedata.border?(imageid.style.border=imagedata.border+"px solid",imageid.style.borderColor=imagedata.titlebackgroundcolor):imageid.style.border="0",0!=imagedata.borderradius?imageid.style.borderRadius=imagedata.borderradius+"px":imageid.style.borderRadius="0";const elementtitle=document.getElementById("id_elementtitle-"+number);elementtitle.innerHTML=imagedata.title,elementtitle.style.color=imagedata.titlecolor,elementtitle.style.backgroundColor=imagedata.titlebackgroundcolor,elementtitle.style.fontSize=imagedata.fontsize+"px",elementtitle.style.borderRadius=imagedata.borderradius+"px"}}function getAllImagedataFromForm(technicalnumber){let imageids={title:"id_unilabeltype_imageboard_title_"+technicalnumber,titlecolor:"id_unilabeltype_imageboard_titlecolor_colourpicker",titlebackgroundcolor:"id_unilabeltype_imageboard_titlebackgroundcolor_colourpicker",titlelineheight:"id_unilabeltype_imageboard_titlelineheight",fontsize:"id_unilabeltype_imageboard_fontsize",alt:"id_unilabeltype_imageboard_alt_"+technicalnumber,xposition:"id_unilabeltype_imageboard_xposition_"+technicalnumber,yposition:"id_unilabeltype_imageboard_yposition_"+technicalnumber,targetwidth:"id_unilabeltype_imageboard_targetwidth_"+technicalnumber,targetheight:"id_unilabeltype_imageboard_targetheight_"+technicalnumber,src:"",border:"id_unilabeltype_imageboard_border_"+technicalnumber,borderradius:"id_unilabeltype_imageboard_borderradius_"+technicalnumber},imagedata={};imagedata.technicalnumber=technicalnumber,imagedata.title=document.getElementById(imageids.title).value,imagedata.titlecolor=document.getElementById(imageids.titlecolor).value,imagedata.titlebackgroundcolor=document.getElementById(imageids.titlebackgroundcolor).value,imagedata.titlelineheight=document.getElementById(imageids.titlelineheight).value,imagedata.fontsize=document.getElementById(imageids.fontsize).value,imagedata.alt=document.getElementById(imageids.alt).value,imagedata.xposition=document.getElementById(imageids.xposition).value,imagedata.yposition=document.getElementById(imageids.yposition).value,imagedata.targetwidth=document.getElementById(imageids.targetwidth).value,imagedata.targetheight=document.getElementById(imageids.targetheight).value;const imagetag=document.getElementById("id_unilabeltype_imageboard_image_"+technicalnumber+"_fieldset").getElementsByTagName("img");let src="";return imagetag.length&&0!=imagetag.length&&(src=imagetag[0].src,src=src.split("?")[0]),imagedata.src=src,imagedata.border=document.getElementById(imageids.border).value,imagedata.borderradius=document.getElementById(imageids.borderradius).value,imagedata}gridtoggler.addEventListener("click",(function(event){const helpergrid=document.getElementById("unilabeltype-imageboard-helpergrid-0");event.stopPropagation(),event.preventDefault(),helpergrid.classList.contains("hidden")?function(button,helpergrid){helpergrid.classList.remove("hidden"),button.value="gridvisible",Str.get_string("buttonlabelhelpergridhide","unilabeltype_imageboard").done((function(text){button.innerText=text}))}(togglerText,helpergrid):function(button,helpergrid){helpergrid.classList.add("hidden"),button.value="gridhidden",Str.get_string("buttonlabelhelpergridshow","unilabeltype_imageboard").done((function(text){button.innerText=text}))}(togglerText,helpergrid)}))}}));

//# sourceMappingURL=imageboardpreviewrenderer.min.js.map
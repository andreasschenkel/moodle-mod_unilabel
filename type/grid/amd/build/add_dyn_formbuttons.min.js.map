{"version":3,"file":"add_dyn_formbuttons.min.js","sources":["../src/add_dyn_formbuttons.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n\n/**\n * @author     Andreas Grabs <moodle@grabs-edv.de>\n * @copyright  2024 Andreas Grabs\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ContentLoader from 'unilabeltype_grid/contentloader';\nimport Templates from 'core/templates';\nimport {exception as displayException} from 'core/notification';\nimport log from 'core/log';\n\nlet _formid;\n\n// Register the del button and get the html from mustache.\nconst registerDelButton = (headerelement, index) => {\n    const context = {\n        repeatindex: index,\n        repeatnr: (index + 1)\n    };\n    return Templates.renderForPromise('unilabeltype_grid/element_action_buttons', context)\n    .then(({html, js}) => {\n        headerelement.querySelector('div.d-flex').insertAdjacentHTML(\n            'beforeend', html\n        );\n        Templates.runTemplateJS(js);\n        return;\n    }).catch((error) => displayException(error));\n};\n\nconst delElement = (index) => {\n    var myelements = [\n        'unilabeltype_grid_title',\n        'unilabeltype_grid_url',\n        'unilabeltype_grid_image',\n        'unilabeltype_grid_image_mobile'\n    ];\n    var myeditorelements = [\n        'unilabeltype_grid_content'\n    ];\n    var headerelement = document.querySelector('#id_singleelementheader_' + index);\n    if (headerelement) {\n        headerelement.remove();\n    }\n    var thisform = document.querySelector('#' + _formid);\n    var myparent = document.querySelector('#id_unilabelcontenthdr');\n    if (myparent) {\n        var newelement;\n        myelements.forEach((element) => {\n            newelement = document.createElement('input');\n            newelement.type = 'hidden';\n            newelement.name = element + '[' + index + ']';\n            newelement.value = '';\n            myparent.insertAdjacentElement('afterbegin', newelement);\n        });\n        myeditorelements.forEach((element) => {\n            newelement = document.createElement('input');\n            newelement.type = 'hidden';\n            newelement.name = element + '[' + index + '][text]';\n            newelement.value = '';\n            myparent.insertAdjacentElement('afterbegin', newelement);\n            newelement = document.createElement('input');\n            newelement.type = 'hidden';\n            newelement.name = element + '[' + index + '][format]';\n            newelement.value = 1;\n            myparent.insertAdjacentElement('afterbegin', newelement);\n            newelement = document.createElement('input');\n            newelement.type = 'hidden';\n            newelement.name = element + '[' + index + '][itemid]';\n            newelement.value = 0;\n            myparent.insertAdjacentElement('afterbegin', newelement);\n        });\n        const myevent = new CustomEvent('itemremoved', {detail: index});\n        thisform.dispatchEvent(myevent);\n    }\n};\n\n// Export our init method.\nexport const init = (formid, contextid, courseid, prefix) => {\n    _formid = formid;\n    // Register a click for the whole form but only applying to the delButtons.\n    var thisform = document.querySelector('#' + formid);\n    thisform.addEventListener('click', (e) => {\n        if (e.target.dataset.action == 'deleteelement') {\n            var index = e.target.dataset.id;\n            log.debug('Deleting element: ' + index);\n            delElement(index);\n        }\n    });\n\n    // Look for the header elements and add and register a delete button.\n    var headerelements = document.querySelectorAll('fieldset[id^=\"id_singleelementheader\"]');\n    for (var i = 0; i < headerelements.length; i++) {\n        var headerelement = headerelements[i];\n        log.debug('looking for: ' + headerelement.id);\n        registerDelButton(headerelement, i);\n    }\n\n    var button = document.querySelector('#button-' + formid);\n    if (button) {\n        var repeatbutton = document.querySelector('#fitem_id_' + prefix + 'add_more_elements_btn');\n        if (repeatbutton) {\n            repeatbutton.remove();\n        }\n        button.addEventListener('click', (e) => {\n            var contentcontainerselector = '#addcontent-' + formid;\n            var fragmentcall = 'get_html';\n            var serviceparams = {\n                'contextid': contextid,\n                'formid': formid,\n                'courseid': courseid,\n                'prefix': prefix\n            };\n\n            var repeatindex = parseInt(e.target.form.unilabeltype_grid_chosen_elements_count.value);\n            e.target.form.unilabeltype_grid_chosen_elements_count.value = repeatindex + 1;\n            serviceparams.repeatindex = repeatindex;\n            log.debug(serviceparams);\n\n            var contentLoader = new ContentLoader(contentcontainerselector, fragmentcall, serviceparams, contextid);\n            contentLoader.loadContent('beforebegin').then(() => {\n                const myevent = new CustomEvent('itemadded', {detail: repeatindex});\n                thisform.dispatchEvent(myevent);\n                return true;\n            }).catch((error) => displayException(error));\n        });\n    }\n};\n"],"names":["_formid","registerDelButton","headerelement","index","context","repeatindex","repeatnr","Templates","renderForPromise","then","_ref","html","js","querySelector","insertAdjacentHTML","runTemplateJS","catch","error","formid","contextid","courseid","prefix","thisform","document","addEventListener","e","target","dataset","action","id","debug","remove","myparent","newelement","forEach","element","createElement","type","name","value","insertAdjacentElement","myevent","CustomEvent","detail","dispatchEvent","delElement","headerelements","querySelectorAll","i","length","button","repeatbutton","contentcontainerselector","serviceparams","parseInt","form","unilabeltype_grid_chosen_elements_count","ContentLoader","loadContent"],"mappings":";;;;;SA2BIA,iOAGEC,kBAAoB,CAACC,cAAeC,eAChCC,QAAU,CACZC,YAAaF,MACbG,SAAWH,MAAQ,UAEhBI,mBAAUC,iBAAiB,2CAA4CJ,SAC7EK,MAAKC,WAACC,KAACA,KAADC,GAAOA,SACVV,cAAcW,cAAc,cAAcC,mBACtC,YAAaH,yBAEPI,cAAcH,OAEzBI,OAAOC,QAAU,2BAAiBA,wBAmDrB,CAACC,OAAQC,UAAWC,SAAUC,UAC9CrB,QAAUkB,WAENI,SAAWC,SAASV,cAAc,IAAMK,QAC5CI,SAASE,iBAAiB,SAAUC,OACD,iBAA3BA,EAAEC,OAAOC,QAAQC,OAA2B,KACxCzB,MAAQsB,EAAEC,OAAOC,QAAQE,gBACzBC,MAAM,qBAAuB3B,OAvDzBA,CAAAA,YAUZD,cAAgBqB,SAASV,cAAc,2BAA6BV,OACpED,eACAA,cAAc6B,aAEdT,SAAWC,SAASV,cAAc,IAAMb,SACxCgC,SAAWT,SAASV,cAAc,6BAClCmB,SAAU,KACNC,WAhBS,CACb,0BACA,wBACA,0BACA,kCAaWC,SAASC,WAChBF,WAAaV,SAASa,cAAc,UACzBC,KAAO,SAClBJ,WAAWK,KAAOH,QAAU,IAAMhC,MAAQ,IAC1C8B,WAAWM,MAAQ,GACnBP,SAASQ,sBAAsB,aAAcP,eAhB9B,CACnB,6BAiBiBC,SAASC,WACtBF,WAAaV,SAASa,cAAc,UACzBC,KAAO,SAClBJ,WAAWK,KAAOH,QAAU,IAAMhC,MAAQ,UAC1C8B,WAAWM,MAAQ,GACnBP,SAASQ,sBAAsB,aAAcP,aAC7CA,WAAaV,SAASa,cAAc,UACzBC,KAAO,SAClBJ,WAAWK,KAAOH,QAAU,IAAMhC,MAAQ,YAC1C8B,WAAWM,MAAQ,EACnBP,SAASQ,sBAAsB,aAAcP,aAC7CA,WAAaV,SAASa,cAAc,UACzBC,KAAO,SAClBJ,WAAWK,KAAOH,QAAU,IAAMhC,MAAQ,YAC1C8B,WAAWM,MAAQ,EACnBP,SAASQ,sBAAsB,aAAcP,qBAE3CQ,QAAU,IAAIC,YAAY,cAAe,CAACC,OAAQxC,QACxDmB,SAASsB,cAAcH,WAanBI,CAAW1C,mBAKf2C,eAAiBvB,SAASwB,iBAAiB,0CACtCC,EAAI,EAAGA,EAAIF,eAAeG,OAAQD,IAAK,KACxC9C,cAAgB4C,eAAeE,gBAC/BlB,MAAM,gBAAkB5B,cAAc2B,IAC1C5B,kBAAkBC,cAAe8C,OAGjCE,OAAS3B,SAASV,cAAc,WAAaK,WAC7CgC,OAAQ,KACJC,aAAe5B,SAASV,cAAc,aAAeQ,OAAS,yBAC9D8B,cACAA,aAAapB,SAEjBmB,OAAO1B,iBAAiB,SAAUC,QAC1B2B,yBAA2B,eAAiBlC,OAE5CmC,cAAgB,WACHlC,iBACHD,gBACEE,gBACFC,QAGVhB,YAAciD,SAAS7B,EAAEC,OAAO6B,KAAKC,wCAAwCjB,OACjFd,EAAEC,OAAO6B,KAAKC,wCAAwCjB,MAAQlC,YAAc,EAC5EgD,cAAchD,YAAcA,yBACxByB,MAAMuB,eAEU,IAAII,uBAAcL,yBAbnB,WAa2DC,cAAelC,WAC/EuC,YAAY,eAAejD,MAAK,WACpCgC,QAAU,IAAIC,YAAY,YAAa,CAACC,OAAQtC,qBACtDiB,SAASsB,cAAcH,UAChB,KACRzB,OAAOC,QAAU,2BAAiBA"}